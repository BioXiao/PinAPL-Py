#!/usr/bin/python
# -*- coding: utf-8 -*-
"""
Created on Mon Oct 10 10:22:56 2016

@author: philipp
"""
# Build library index
# =======================================================================
# Imports
import pandas as pd
import yaml
import os
import time
import sys
from Bowtie2 import BuildIndex

def BuildBowtieIndex():

    # ------------------------------------------------
    # Print header
    # ------------------------------------------------
    print('**************************************************************')
    print('PinAPL-Py: Library Index Preparation')
    print('**************************************************************')  
    start_total = time.time()  

    # ------------------------------------------------
    # Get parameters
    # ------------------------------------------------
    os.chdir('/workingdir/')    
    configFile = open('configuration.yaml','r')
    config = yaml.load(configFile)
    configFile.close()
    bw2Dir = config['bw2Dir']    
    LibDir = config['LibDir']
    IndexDir = LibDir+'Bowtie2_Index/'
    LibFilename = config['LibFilename']

    # ----------------------------------
    # Convert library to fasta
    # ----------------------------------
    print('Converting library to fasta format ...') 
    os.chdir(LibDir)
    LibCols = ['gene','ID','seq']
    LibFile = pd.read_table(LibFilename, sep = '\t', skiprows = 1, names = LibCols)
    seq = Libfile['seq'].values
    IDs = Libfile['ID'].values    
    with open('library.fasta','w') as library_fasta:
        for k in range(len(IDs)):
            library_fasta.write('>'+IDs[k]+'\n')
            library_fasta.write(seq[k]+'\n')
    library_fasta.close()
    
    # ----------------------------------
    # Call bowtie2 index builder
    # ----------------------------------   
    print('Building library index ...')     
    if not os.path.exists(IndexDir):
        os.makedirs(IndexDir)
    os.rename('library.fasta',IndexDir+'library.fasta')
    BuildIndex('library.fasta',IndexDir,bw2Dir)

    # --------------------------------------
    # Final time stamp
    # --------------------------------------        
    end_total = time.time()
    # Final time stamp
    print('------------------------------------------------')
    print('Script completed.')    
    sec_elapsed = end_total - start_total
    if sec_elapsed < 60:
        time_elapsed = sec_elapsed
        print('Time elapsed (Total) [secs]: ' + '%.3f' % time_elapsed +'\n')
    elif sec_elapsed < 3600:
        time_elapsed = sec_elapsed/60
        print('Time elapsed (Total) [mins]: ' + '%.3f' % time_elapsed +'\n')
    else:
        time_elapsed = sec_elapsed/3600
        print('Time elapsed (Total) [hours]: ' + '%.3f' % time_elapsed +'\n')            


   
if __name__ == "__main__":
    BuildBowtieIndex()
